{% extends 'base.html' %}
{% load static %}
{% block title %}System Admin Dashboard{% endblock %}

{% block extra_head %}
<style>
    /* Toggle Icons - Always show plus initially, minus when expanded */
    .btn-toggle-details .icon-plus { display: inline-block !important; }
    .btn-toggle-details .icon-minus { display: none !important; }
    
    .btn-toggle-details[aria-expanded="true"] .icon-plus { display: none !important; }
    .btn-toggle-details[aria-expanded="true"] .icon-minus { display: inline-block !important; }
    
    /* Clean Button */
    .btn-icon-clean {
        border: none; background: transparent; color: #001F54;
        width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
        padding: 0; border-radius: 50%; transition: background-color 0.2s;
    }
    .btn-icon-clean:hover { background-color: #e9ecef; }

    .comment-section { display: none; }
    
    /* Tabs */
    .nav-tabs .nav-link { color: #001F54; font-weight: 600; }
    .nav-tabs .nav-link.active { background-color: #001F54; color: #FFD700; border-color: #001F54; }
    
    #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; }
</style>
{% endblock %}

{% block content %}
<div id="toast-container"></div>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">{{ system_name }} ‚Äì System Admin Dashboard</h3>
    </div>

    <div class="row text-center mb-4">
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0" style="background-color:#001F54; color:#FFD700;">
                <div class="card-body p-2"><h6>Total</h6><h4>{{ total_requests }}</h4></div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0 bg-warning text-dark">
                <div class="card-body p-2"><h6>Pending</h6><h4>{{ pending_requests }}</h4></div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0 bg-success text-white">
                <div class="card-body p-2"><h6>Approved</h6><h4>{{ approved_requests }}</h4></div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0 bg-danger text-white">
                <div class="card-body p-2"><h6>Rejected</h6><h4>{{ rejected_requests }}</h4></div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0 bg-info text-dark">
                <div class="card-body p-2"><h6>Today</h6><h4>{{ today_requests }}</h4></div>
            </div>
        </div>
    </div>

    <form method="get" class="row g-3 mb-4 bg-white p-3 rounded shadow-sm align-items-end">
        <input type="hidden" name="active_tab" id="id_active_tab" value="{{ active_tab }}">
        
        <div class="col-md-4">
            <label class="form-label small fw-bold text-muted">Search Staff</label>
            <input type="text" name="tsc" class="form-control" placeholder="TSC Number..." value="{{ request.GET.tsc }}">
        </div>
        <div class="col-md-2">
            <label class="form-label small fw-bold text-muted">From</label>
            <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
        </div>
        <div class="col-md-2">
            <label class="form-label small fw-bold text-muted">To</label>
            <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" style="background-color: #001F54;">Filter</button>
        </div>
        <div class="col-md-2 d-flex justify-content-end">
             <a href="?{{ request.GET.urlencode }}&export_excel=1" class="btn btn-success btn-sm me-1" title="Export Excel"><i class="bi bi-file-earmark-excel"></i> XLS</a>
             <a href="?{{ request.GET.urlencode }}&export_pdf=1" class="btn btn-danger btn-sm" title="Export PDF"><i class="bi bi-file-earmark-pdf"></i> PDF</a>
        </div>
    </form>

    <ul class="nav nav-tabs mb-3" id="sysTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link {% if active_tab == 'pending' %}active{% endif %}" 
                    id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button"
                    onclick="setActiveTab('pending')">
                ‚è≥ Pending Actions
                {% if pending_requests > 0 %}<span class="badge bg-danger rounded-pill ms-1">{{ pending_requests }}</span>{% endif %}
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link {% if active_tab == 'history' %}active{% endif %}" 
                    id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button"
                    onclick="setActiveTab('history')">
                üìú History
            </button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade {% if active_tab == 'pending' %}show active{% endif %}" id="pending">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-light">Pending Requests</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;"></th> <th>Requester</th> <th>TSC No</th> <th>Designation</th> <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for req in requests %}
                            <tr class="fw-bold" style="background-color: #f8f9fa;">
                                <td>
                                    <button class="btn btn-icon-clean btn-toggle-details" type="button" aria-expanded="false" data-bs-toggle="collapse" data-bs-target="#details-{{ req.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-plus-circle-fill icon-plus" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/></svg>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-dash-circle-fill icon-minus" viewBox="0 0 16 16" style="color: #dc3545;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z"/></svg>
                                    </button>
                                </td>
                                <td>{{ req.requester.full_name }}</td>
                                <td class="text-primary">{{ req.tsc_no }}</td>
                                <td>{{ req.designation }}</td>
                                <td>{{ req.submitted_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="p-0 border-0">
                                    <div class="collapse" id="details-{{ req.id }}">
                                        <div class="card card-body bg-light m-3 border shadow-sm">
                                            <table class="table table-sm table-bordered bg-white">
                                                <thead class="table-secondary">
                                                    <tr><th>System</th> <th>Access Level</th> <th>Action</th></tr>
                                                </thead>
                                                <tbody>
                                                    {% for sys in req.requested_systems.all %}
                                                        {% if sys.sysadmin_status == 'pending' %}
                                                        <tr data-system-id="{{ sys.id }}">
                                                            <td>{{ sys.get_system_display }}</td>
                                                            <td>{{ sys.level_of_access }}</td>
                                                            <td>
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-dark dropdown-toggle btn-dropdown-toggle" type="button" 
                                                                            data-bs-toggle="dropdown" 
                                                                            data-bs-boundary="viewport" 
                                                                            data-bs-auto-close="outside">
                                                                        Action
                                                                    </button>
                                                                    <div class="dropdown-menu p-3 shadow" style="width: 280px;">
                                                                        <form method="post" action="{% url 'system_admin_decision' sys.id %}?{{ request.GET.urlencode }}">
                                                                            {% csrf_token %}
                                                                            <div class="mb-2">
                                                                                <label class="small fw-bold">Decision</label>
                                                                                <select name="action" class="form-select form-select-sm decision-select">
                                                                                    <option value="approve">Grant Access</option>
                                                                                    <option value="reject">Reject</option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="mb-2 comment-section">
                                                                                <label class="small fw-bold">Reason</label>
                                                                                <textarea name="comment" rows="2" class="form-control form-control-sm" placeholder="Reason..."></textarea>
                                                                            </div>
                                                                            <button type="submit" class="btn btn-primary btn-sm w-100 action-btn">Confirm</button>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="5" class="text-center p-4">No pending requests for {{ system_name }}.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'history' %}show active{% endif %}" id="history">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">My Approval History</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;"></th> <th>Requester</th> <th>TSC No</th> <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for req in history %}
                            <tr class="fw-bold" style="background-color: #e2e3e5;">
                                <td>
                                    <button class="btn btn-icon-clean btn-toggle-details" type="button" aria-expanded="false" data-bs-toggle="collapse" data-bs-target="#hist-{{ req.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-plus-circle-fill icon-plus" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/></svg>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-dash-circle-fill icon-minus" viewBox="0 0 16 16" style="color: #dc3545;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z"/></svg>
                                    </button>
                                </td>
                                <td>{{ req.requester.full_name }}</td>
                                <td class="text-primary">{{ req.tsc_no }}</td>
                                <td>{{ req.submitted_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="p-0 border-0">
                                    <div class="collapse" id="hist-{{ req.id }}">
                                        <div class="card card-body bg-light m-3 border shadow-sm">
                                            <table class="table table-sm table-bordered bg-white">
                                                <thead class="table-secondary">
                                                    <tr><th>System</th> <th>Level</th> <th>Decision</th> <th>Date</th> <th>Comment</th></tr>
                                                </thead>
                                                <tbody>
                                                    {% for sys in req.requested_systems.all %}
                                                        {% if sys.system_admin == request.user %}
                                                        <tr>
                                                            <td>{{ sys.get_system_display }}</td>
                                                            <td>{{ sys.level_of_access }}</td>
                                                            <td>
                                                                {% if sys.sysadmin_status == 'approved' %}
                                                                    <span class="badge bg-success">Granted</span>
                                                                {% else %}
                                                                    <span class="badge bg-danger">Rejected</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ sys.sysadmin_decision_date|date:"M d, Y H:i" }}</td>
                                                            <td><small class="text-muted">{{ sys.sysadmin_comment|default:"-" }}</small></td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="5" class="text-center p-4">No history found.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function setActiveTab(tabName) {
        document.getElementById('id_active_tab').value = tabName;
    }

    // ‚ú® AJAX Notification Helper
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.insertAdjacentElement('afterbegin', alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // ‚ú® AJAX Form Submission
    function initializeAjaxForms() {
        // More robust selector - matches forms within decision dropdowns
        const forms = document.querySelectorAll('form[method="post"]');
        console.log(`Found ${forms.length} total POST forms, filtering for system-admin...`);
        
        let ajaxyCount = 0;
        forms.forEach((form, index) => {
            const action = form.getAttribute('action');
            if (action && action.includes('/system-admin/')) {
                console.log(`[AJAX-${++ajaxyCount}] Attaching handler to form with action: ${action}`);
                form.addEventListener("submit", function(e) {
                    e.preventDefault();
                    console.log("AJAX form submission intercepted!");
                    
                    const formData = new FormData(this);
                    const actionVal = formData.get('action');
                    const comment = formData.get('comment');
                    const url = this.getAttribute('action');
                    const csrfToken = this.querySelector('[name="csrfmiddlewaretoken"]').value;
                    
                    // Validate reject requires comment
                    if (actionVal === 'reject' && !comment.trim()) {
                        showNotification("Please provide a reason for rejection", "error");
                        return;
                    }
                    
                    // Send AJAX request
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        },
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            
                            // Find the table row for this system and update it
                            const systemId = data.system_id;
                            const row = document.querySelector(`tr[data-system-id="${systemId}"]`);
                            
                            if (row) {
                                // In the pending table, columns are: System (0), Access Level (1), Action (2)
                                const cells = row.querySelectorAll('td');
                                
                                // Hide the action dropdown button
                                const actionCell = cells[2];
                                const dropdownBtn = actionCell.querySelector('.btn-dropdown-toggle');
                                if (dropdownBtn) {
                                    dropdownBtn.style.display = 'none';
                                    // Replace button with status badge
                                    dropdownBtn.insertAdjacentHTML('afterend', `<span class="badge ${data.badge_class}">${data.status}</span>`);
                                }
                                
                                // Close the dropdown
                                const dropdown = this.closest('.dropdown-menu');
                                if (dropdown) {
                                    const dropdownToggle = dropdown.previousElementSibling;
                                    if (dropdownToggle && dropdownToggle.classList.contains('dropdown-toggle')) {
                                        const dropdownInstance = bootstrap.Dropdown.getInstance(dropdownToggle);
                                        if (dropdownInstance) dropdownInstance.hide();
                                    }
                                }
                                
                                // Visual feedback
                                row.style.backgroundColor = '#e8f5e9';
                                setTimeout(() => {
                                    row.style.opacity = '0.7';
                                }, 500);
                            }
                        } else {
                            showNotification(data.error || "An error occurred", "error");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        showNotification("Failed to process decision. Please try again.", "error");
                    });
                });
            }
        });
    }

    // ‚ú® SIMPLIFIED AJAX Form Handler - Direct Approach
    function initializeFormHandlers() {
        console.log("üì¢ [INIT] Starting form handler initialization");
        
        // Use global selector - get ALL forms first
        const allForms = document.querySelectorAll('form');
        console.log(`üìä [INIT] Total forms on page: ${allForms.length}`);
        
        let systemAdminFormCount = 0;
        
        allForms.forEach((form, idx) => {
            const actionUrl = form.getAttribute('action');
            console.log(`   Form ${idx}: action="${actionUrl}"`);
            
            // Check if this is a system admin decision form
            if (actionUrl && actionUrl.includes('/system-admin/decision/')) {
                // Check if already attached (prevent double listeners)
                if (form.dataset.ajaxAttached === 'true') {
                    console.log(`   ‚è≠Ô∏è Already attached, skipping`);
                    return;
                }
                
                systemAdminFormCount++;
                form.dataset.ajaxAttached = 'true';
                console.log(`‚úÖ [FORM-${systemAdminFormCount}] System admin form detected`);
                
                // Add listener directly
                form.addEventListener('submit', handleSystemAdminDecision);
            }
        });
        
        console.log(`‚úÖ [INIT] Attached handlers to ${systemAdminFormCount} decision forms\n`);
    }

    // Dedicated handler function
    function handleSystemAdminDecision(event) {
        event.preventDefault();
        console.log(`üîµ [SUBMIT] Form submitted`);
        
        const form = event.target;
        const action = form.querySelector('[name="action"]').value;
        const comment = form.querySelector('[name="comment"]').value;
        const url = form.getAttribute('action');
        
        console.log(`   Action: ${action}`);
        console.log(`   Comment: "${comment}"`);
        console.log(`   URL: ${url}`);
        console.log(`   Form method: ${form.getAttribute('method')}`);
        console.log(`   Form has CSRF: ${!!form.querySelector('[name="csrfmiddlewaretoken"]')}`);
        
        // Validation
        if (action === 'reject' && !comment.trim()) {
            console.warn(`   ‚ö†Ô∏è Reject without comment`);
            showNotification("‚ö†Ô∏è Please provide a reason for rejection", "error");
            return;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        
        // Build FormData
        const formData = new FormData(form);
        console.log(`üì§ [FETCH] Payload size: ${new Blob(Object.entries(formData)).size} bytes`);
        console.log(`üì§ [FETCH] Request URL: ${url}`);
        
        // Send request
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            console.log(`üì• [RESPONSE] HTTP Status: ${response.status}`);
            console.log(`üì• [RESPONSE] Content-Type: ${response.headers.get('content-type')}`);
            
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }
            
            // Try to parse as JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error(`Expected JSON, got: ${contentType}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log(`‚ú® [SUCCESS] Response data:`, data);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            
            if (data.success) {
                // Show success notification
                showNotification(`‚úÖ ${data.message}`, 'success');
                
                // Find and remove the row
                const systemRow = document.querySelector(`tr[data-system-id="${data.system_id}"]`);
                if (systemRow) {
                    console.log(`üóëÔ∏è [ROW] Found row, removing...`);
                    systemRow.style.opacity = '0';
                    systemRow.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        systemRow.remove();
                        console.log(`üóëÔ∏è [ROW] Removed successfully`);
                    }, 300);
                } else {
                    console.warn(`‚ö†Ô∏è [ROW] Not found for data-system-id="${data.system_id}"`);
                    console.log(`   Available rows:`, document.querySelectorAll('tr[data-system-id]'));
                }
            } else {
                console.error(`‚ùå [RESPONSE] Error from server:`, data.error);
                showNotification(`‚ùå ${data.error || 'Unknown error'}`, 'error');
            }
        })
        .catch(error => {
            console.error(`‚ùå [ERROR] Fetch failed:`, error);
            console.error(`   Error message: ${error.message}`);
            console.error(`   Error stack:`, error.stack);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            showNotification(`‚ö†Ô∏è Error: ${error.message}`, 'error');
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        console.log("üéØ [DOMContentLoaded] Page loaded");
        
        // Initialize form handlers
        initializeFormHandlers();
        
        // Watch for new forms being added (e.g., when collapse is opened)
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    const newForms = mutation.target.querySelectorAll('form[action*="/system-admin/decision/"]');
                    if (newForms.length > 0) {
                        console.log("üîç [OBSERVER] New forms detected, re-initializing...");
                        initializeFormHandlers();
                    }
                }
            });
        });
        
        observer.observe(document.body, { 
            childList: true, 
            subtree: true 
        });
        
        console.log("üëÅÔ∏è [OBSERVER] MutationObserver active\n");

        // Setup decision select handlers (show/hide comment section)
        const selects = document.querySelectorAll(".decision-select");
        selects.forEach(select => {
            select.addEventListener("change", function() {
                const form = this.closest("form");
                const commentSection = form.querySelector(".comment-section");
                const textarea = commentSection.querySelector("textarea");
                const btn = form.querySelector(".action-btn");

                if (this.value === "reject") {
                    commentSection.style.display = "block";
                    textarea.setAttribute("required", "true");
                    btn.classList.remove("btn-primary");
                    btn.style.backgroundColor = "#FFD700"; 
                    btn.style.borderColor = "#FFD700";
                    btn.style.color = "#001F54";
                    btn.textContent = "Confirm Reject";
                } else {
                    commentSection.style.display = "none";
                    textarea.removeAttribute("required");
                    btn.style.backgroundColor = ""; 
                    btn.style.borderColor = "";
                    btn.style.color = "";
                    btn.classList.add("btn-primary");
                    btn.textContent = "Confirm";
                }
            });
            select.dispatchEvent(new Event("change"));
        });
    });
</script>
{% endblock %}