{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* ... (Keep all your existing CSS styles for Cards, Grid, Header) ... */
    .dashboard-container { padding: 20px; font-family: 'Segoe UI', sans-serif; }
    .dash-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 3px solid #FFD700; padding-bottom: 15px; }
    .dash-title { color: #001F54; font-size: 24px; font-weight: 800; }
    .metric-card { background: white; padding: 20px; border-left: 6px solid #001F54; border-radius: 10px; flex: 1; margin-right: 20px; }
    .metric-card.danger { border-left-color: #dc3545; }
    .metric-card h3 { color: #666; font-size: 13px; text-transform: uppercase; margin: 0; }
    .metric-card .value { font-size: 32px; font-weight: 800; color: #001F54; }
    .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
    .panel { background: white; padding: 20px; border-radius: 10px; }
    .styled-table { width: 100%; border-collapse: collapse; }
    .styled-table th { background: #001F54; color: #FFD700; padding: 10px; text-align: left; }
    .styled-table td { padding: 10px; border-bottom: 1px solid #eee; }
    .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .nav-link { padding: 10px 20px; cursor: pointer; color: #001F54; font-weight: bold; }
    .nav-link.active { border-bottom: 3px solid #001F54; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dash-header">
        <h1 class="dash-title">üìä Executive Command Center</h1>
        <div>
            <a href="?export_excel=1" style="background:#28a745; color:white; padding:8px; border-radius:5px; text-decoration:none;">Excel</a>
        </div>
    </div>

    <div style="display:flex;">
        <div class="metric-card"><h3>Total Requests</h3><div class="value">{{ total_requests }}</div></div>
        <div class="metric-card danger"><h3>‚ö†Ô∏è Overdue</h3><div class="value">{{ overdue_requests }}</div></div>
        <div class="metric-card"><h3>Active Staff Given Rights</h3><div class="value">{{ active_staff_count }}</div></div>
    </div>

    <div style="margin-top: 30px;">
        <div class="nav-tabs">
            <div class="nav-link active" onclick="openTab(event, 'overview')">Overview</div>
            <div class="nav-link" onclick="openTab(event, 'logs')">System Access Logs</div>
        </div>
    </div>

    <div id="overview" class="tab-content active">
        <div class="content-grid">
            <div class="panel">
                <h4>System Access Distribution</h4>
                <canvas id="rightsChart" height="150"></canvas>
            </div>
            <div class="panel">
                <h4>Top Systems</h4>
                <table class="styled-table">
                    <thead><tr><th>System</th><th>Users</th></tr></thead>
                    <tbody>
                        {% for item in granted_rights %}
                        <tr><td>{{ item.name }}</td><td>{{ item.count }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="logs" class="tab-content">
        <div class="panel">
            <h4 style="color: #001F54;">Recent User Access (Last 20 Logins)</h4>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Action</th>
                        <th>Time</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_logs %}
                    <tr>
                        <td>
                            <strong>{{ log.user.full_name }}</strong><br>
                            <small style="color:gray;">{{ log.user.tsc_no }}</small>
                        </td>
                        <td>
                            <span style="color: green; font-weight: bold;">{{ log.action }}</span>
                        </td>
                        <td>{{ log.timestamp|date:"M d, Y H:i" }}</td>
                        <td>{{ log.ip_address }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4">No logs found yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <div style="margin-top: 15px; text-align: right;">
                <a href="{% url 'admin:access_request_accesslog_changelist' %}" style="color: #001F54; font-weight: bold;">View All Logs &rarr;</a>
            </div>
        </div>
    </div>
</div>

{{ chart_labels|json_script:"chart-labels-data" }}
{{ chart_data|json_script:"chart-data-data" }}

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, navlinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].classList.remove("active"); }
        navlinks = document.getElementsByClassName("nav-link");
        for (i = 0; i < navlinks.length; i++) { navlinks[i].classList.remove("active"); }
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }
    // ... (Chart JS logic remains same) ...
    document.addEventListener("DOMContentLoaded", function() {
        const ctx = document.getElementById('rightsChart').getContext('2d');
        const labels = JSON.parse(document.getElementById('chart-labels-data').textContent);
        const dataPoints = JSON.parse(document.getElementById('chart-data-data').textContent);
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Users',
                    data: dataPoints,
                    backgroundColor: '#001F54',
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    });
</script>
{% endblock %}